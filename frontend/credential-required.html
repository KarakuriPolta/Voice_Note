<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>認証情報が必要です</title>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Voice Note</h1>
        </header>
        <h2>Googleサービスアカウント認証情報がありません</h2>
        <p>セットアップが完了していません。<br>
        <a href="http://localhost:3000/setup.html" target="_blank">セットアップ方法はこちら</a></p>
        <p>認証JSONファイルをアップロードしてください。</p>
        <input type="file" id="jsonFile" accept=".json">
        <div id="status"></div>
        <button id="reloadBtn" style="display:none;">リロード</button>
    </div>
    <script>
        const fileInput = document.getElementById('jsonFile');
        const statusDiv = document.getElementById('status');
        const reloadBtn = document.getElementById('reloadBtn');
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.json')) {
                statusDiv.textContent = 'JSONファイルのみアップロード可能';
                return;
            }
            statusDiv.textContent = 'アップロード中...';
            const reader = new FileReader();
            reader.onload = async (event) => {
                let jsonText = event.target.result;
                try {
                    JSON.parse(jsonText);
                } catch (err) {
                    statusDiv.textContent = 'JSONのパースに失敗: ' + err.message;
                    return;
                }

                try {
                    const res = await fetch('/api/upload-credentials', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: jsonText
                    });
                    if (res.ok) {
                        statusDiv.textContent = 'アップロード完了。リロードしてください。';
                        reloadBtn.style.display = '';
                    } else {
                        const errJson = await res.json().catch(() => ({}));
                        statusDiv.textContent = 'アップロード失敗: ' + (errJson.error || res.statusText);
                    }
                } catch (e) {
                    statusDiv.textContent = 'アップロード通信エラー: ' + e.message;
                }
                
            };
            reader.onerror = (err) => {
                statusDiv.textContent = 'ファイル読み込みエラー: ' + err.message;
            };
            reader.readAsText(file);
        });
        reloadBtn.onclick = () => location.reload();
    </script>
</body>
</html>
